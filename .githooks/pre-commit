#!/bin/sh
# Secret guard (scan ONLY ADDED staged lines, excluding this hook file)
# - Avoid false positives on docs/env var names
# - Block common real key patterns

diff="$(git diff --cached -U0 -- . ':(exclude).githooks/pre-commit')"
added="$(printf "%s\n" "$diff" | grep -E '^\+' | grep -vE '^\+\+\+')"

echo "$added" | grep -E -n \
  'sk-[A-Za-z0-9]{20,}|-----BEGIN [A-Z ]+ PRIVATE KEY-----|ghp_[A-Za-z0-9]{30,}|xox[baprs]-[A-Za-z0-9-]{10,}' \
  >/dev/null 2>&1

if [ $? -eq 0 ]; then
  echo "ERROR: Possible secret detected in staged ADDED lines. Aborting commit."
  echo "Fix: remove the secret, use env vars, or keep it in untracked .local files."
  exit 1
fi

exit 0